{% extends "layout.html" %}

{% block content %}
<style>
    #radarr_table {
        table-layout: fixed;
        width: 100%;
    }
    #radarr_table th,
    #radarr_table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #radarr_table th:nth-child(1),
    #radarr_table td:nth-child(1) { width: 36%; }
    #radarr_table th:nth-child(2),
    #radarr_table td:nth-child(2) { width: 8%; }
    #radarr_table th:nth-child(3),
    #radarr_table td:nth-child(3) { width: 12%; }
    #radarr_table th:nth-child(4),
    #radarr_table td:nth-child(4) { width: 12%; }
    #radarr_table th:nth-child(5),
    #radarr_table td:nth-child(5) { width: 10%; }
    #radarr_table th:nth-child(6),
    #radarr_table td:nth-child(6) { width: 10%; }
</style>
<div class="d-flex flex-wrap align-items-center gap-2 mb-2">
    <h2 class="mb-0">Radarr Movies</h2>
    <button class="btn btn-sm btn-outline-primary ms-auto" type="button" id="radarr-sync-btn" data-bs-toggle="modal" data-bs-target="#radarrSyncModal">
        Sync to Wanted
    </button>
</div>
{% set stats = namespace(total=0, monitored=0, downloaded=0) %}
{% for m in movies %}
    {% set stats.total = stats.total + 1 %}
    {% if m.monitored %}{% set stats.monitored = stats.monitored + 1 %}{% endif %}
    {% if m.has_file %}{% set stats.downloaded = stats.downloaded + 1 %}{% endif %}
{% endfor %}
<p>
    Total Movies: {{ stats.total }} |
    Monitorati: {{ stats.monitored }} |
    Scaricati: {{ stats.downloaded }}
</p>

<table id="radarr_table" class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Title</th>
            <th>Year</th>
            <th>TMDb ID</th>
            <th>IMDb ID</th>
            <th>Monitored</th>
            <th>Downloaded</th>
        </tr>
    </thead>
    <tbody>
        {% for m in movies %}
        <tr>
            <td>
                <a href="{{ radarr_url }}/movie/{{ m.tmdb_id }}" target="_blank">
                    {{ m.title }}
                </a>
            </td>
            <td>{{ m.year }}</td>
            <td>{{ m.tmdb_id }}</td>
            <td>{{ m.imdb_id }}</td>
            <td>{{ "Yes" if m.monitored else "No" }}</td>
            <td>{{ "Yes" if m.has_file else "No" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<div class="modal fade" id="radarrSyncModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sync Radarr â†’ Wanted</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="radarr-sync-loading">Caricamento dati Radarr...</div>
                <div class="alert alert-danger d-none" id="radarr-sync-error">Errore durante il sync.</div>
                <div id="radarr-sync-summary" class="mb-3 d-none">
                    <span class="badge bg-primary">Totali: <span id="radarr-sync-total">0</span></span>
                    <span class="badge bg-success">Gia in Wanted: <span id="radarr-sync-present">0</span></span>
                    <span class="badge bg-warning text-dark">Da importare: <span id="radarr-sync-missing">0</span></span>
                </div>
                <div id="radarr-sync-list" class="d-none">
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="radarr-sync-select-all">Seleziona tutti</button>
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="radarr-sync-clear">Deseleziona</button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped align-middle">
                            <thead>
                                <tr>
                                    <th style="width: 36px;"></th>
                                    <th>Title</th>
                                    <th>Year</th>
                                    <th>TMDb</th>
                                    <th>Match</th>
                                </tr>
                            </thead>
                            <tbody id="radarr-sync-rows"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                <button class="btn btn-primary" id="radarr-sync-import" disabled>Importa selezionati</button>
            </div>
        </div>
    </div>
</div>

<!-- DataTables JS/CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    $('#radarr_table').DataTable({
        "paging": true,
        "ordering": true,
        "order": [[1, "desc"]],  // default: order by Title descending
        "pageLength": 25
    });

    var syncCache = null;

    function updateSyncButtonState() {
        var count = $('#radarr-sync-rows').find('input[type="checkbox"]:checked').length;
        $('#radarr-sync-import').prop('disabled', count === 0);
    }

    function renderSyncRows(items) {
        var rows = items.map(function(item, idx) {
            var tmdb = item.tmdb_id ? String(item.tmdb_id) : '';
            var match = item.match_type === 'tmdb' ? 'TMDB' : (item.match_type === 'title_year' ? 'Titolo/Anno' : '-');
            var label = item.title || '';
            return '<tr>' +
                '<td><input class="form-check-input radarr-sync-select" type="checkbox" data-index="' + idx + '" checked></td>' +
                '<td>' + label + '</td>' +
                '<td>' + (item.year || '') + '</td>' +
                '<td>' + tmdb + '</td>' +
                '<td>' + match + '</td>' +
            '</tr>';
        }).join('');
        $('#radarr-sync-rows').html(rows);
        updateSyncButtonState();
    }

    $('#radarrSyncModal').on('show.bs.modal', function() {
        $('#radarr-sync-error').addClass('d-none');
        $('#radarr-sync-summary').addClass('d-none');
        $('#radarr-sync-list').addClass('d-none');
        $('#radarr-sync-rows').empty();
        $('#radarr-sync-import').prop('disabled', true).text('Importa selezionati');
        if (syncCache) {
            $('#radarr-sync-total').text(syncCache.counts.total);
            $('#radarr-sync-present').text(syncCache.counts.present);
            $('#radarr-sync-missing').text(syncCache.counts.missing);
            $('#radarr-sync-summary').removeClass('d-none');
            if (syncCache.missing.length) {
                renderSyncRows(syncCache.missing);
                $('#radarr-sync-list').removeClass('d-none');
            }
            return;
        }
        $('#radarr-sync-loading').removeClass('d-none');
        fetch('/api/radarr/sync/preview')
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                $('#radarr-sync-loading').addClass('d-none');
                if (!data || !data.ok) {
                    throw new Error('sync failed');
                }
                syncCache = data;
                $('#radarr-sync-total').text(data.counts.total);
                $('#radarr-sync-present').text(data.counts.present);
                $('#radarr-sync-missing').text(data.counts.missing);
                $('#radarr-sync-summary').removeClass('d-none');
                if (data.missing.length) {
                    renderSyncRows(data.missing);
                    $('#radarr-sync-list').removeClass('d-none');
                }
            })
            .catch(function() {
                $('#radarr-sync-loading').addClass('d-none');
                $('#radarr-sync-error').removeClass('d-none');
            });
    });

    $('#radarrSyncModal').on('hidden.bs.modal', function() {
        $('#radarr-sync-loading').addClass('d-none');
        $('#radarr-sync-error').addClass('d-none');
    });

    $(document).on('change', '.radarr-sync-select', function() {
        updateSyncButtonState();
    });

    $('#radarr-sync-select-all').on('click', function() {
        $('#radarr-sync-rows').find('input[type="checkbox"]').prop('checked', true);
        updateSyncButtonState();
    });

    $('#radarr-sync-clear').on('click', function() {
        $('#radarr-sync-rows').find('input[type="checkbox"]').prop('checked', false);
        updateSyncButtonState();
    });

    $('#radarr-sync-import').on('click', function() {
        if (!syncCache || !syncCache.missing.length) {
            return;
        }
        var button = $(this);
        var selected = [];
        $('#radarr-sync-rows').find('input[type="checkbox"]:checked').each(function() {
            var idx = parseInt($(this).data('index'), 10);
            if (!Number.isNaN(idx) && syncCache.missing[idx]) {
                selected.push(syncCache.missing[idx]);
            }
        });
        if (!selected.length) {
            return;
        }
        button.prop('disabled', true).text('Importo...');
        fetch('/api/radarr/sync/import', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: selected })
        })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (!data || !data.ok) {
                    throw new Error('import failed');
                }
                syncCache = null;
                button.text('Importati');
                setTimeout(function() {
                    var modalEl = document.getElementById('radarrSyncModal');
                    if (modalEl) {
                        var modal = bootstrap.Modal.getInstance(modalEl);
                        if (modal) {
                            modal.hide();
                        }
                    }
                }, 1000);
            })
            .catch(function() {
                $('#radarr-sync-error').removeClass('d-none').text('Errore durante l\'import.');
                button.prop('disabled', false).text('Importa selezionati');
            });
    });
});
</script>

{% endblock %}
