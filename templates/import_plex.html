{% extends "layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/import_plex.css') }}">
{% endblock %}

{% block content %}
<h2><i class="bi bi-database me-2"></i>Plex Import</h2>

{% if not preview %}
<form method="post" enctype="multipart/form-data" class="mt-3 mb-4" id="plex-preview-form">
    <input type="hidden" name="action" value="preview">
    <input type="file" name="file" accept=".db" required>
    <div class="d-flex flex-wrap gap-4 mt-3">
        <div class="d-flex flex-column gap-2">
            <div class="fw-semibold">Film</div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="import-movies" name="import_movies" value="1" checked>
                <label class="form-check-label" for="import-movies">Importa film</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="match-movies" name="match_movies" value="1" checked>
                <label class="form-check-label" for="match-movies">Match TMDB per film (Radarr)</label>
            </div>
        </div>
        <div class="d-flex flex-column gap-2">
            <div class="fw-semibold">Serie</div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="import-series" name="import_series" value="1" checked>
                <label class="form-check-label" for="import-series">Importa serie</label>
            </div>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="match-series" name="match_series" value="1" checked>
                <label class="form-check-label" for="match-series">Match TVDB per serie (Sonarr)</label>
            </div>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Analizza DB</button>
</form>
{% endif %}

{% if preview %}
<form method="post">
    <input type="hidden" name="action" value="import">
    <input type="hidden" name="filepath" value="{{ preview.filepath }}">
    <input type="hidden" name="match_movies" value="{{ '1' if preview.options.match_movies else '0' }}">
    <input type="hidden" name="match_series" value="{{ '1' if preview.options.match_series else '0' }}">
    <input type="hidden" name="import_movies" value="{{ '1' if preview.options.import_movies else '0' }}">
    <input type="hidden" name="import_series" value="{{ '1' if preview.options.import_series else '0' }}">

    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <span class="badge bg-primary">Film: {{ preview.movies|length }}</span>
        <span class="badge bg-secondary">Serie: {{ preview.series|length }}</span>
        {% if preview.excluded %}
            <span class="badge bg-warning text-dark">Esclusi: {{ preview.excluded|length }}</span>
        {% endif %}
        <span class="badge bg-info text-dark">Selezionati: <span id="selected-total">0</span></span>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-btn">Seleziona tutti</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-all-btn">Deseleziona</button>
        <button type="submit" class="btn btn-success" id="import-btn">Importa selezionati</button>
    </div>
    {% if preview.excluded %}
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#plex-excluded" aria-expanded="false" aria-controls="plex-excluded">
            Esclusi ({{ preview.excluded|length }})
        </button>
    </div>
    <div class="collapse mb-4" id="plex-excluded">
        <div class="alert alert-warning py-2 small">
            Esclusi perche gia presenti nei wanted (match esatto titolo/anno).
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
                <thead>
                    <tr>
                        <th>Titolo</th>
                        <th>Anno</th>
                        <th>Tipo</th>
                        <th>Motivo</th>
                    </tr>
                </thead>
                <tbody>
                {% for ex in preview.excluded|sort(attribute='title') %}
                    <tr>
                        <td>{{ ex.title }}</td>
                        <td>{{ ex.year }}</td>
                        <td>{{ ex.media_type }}</td>
                        <td class="text-muted">
                            {{ ex.reason }}
                            {% if ex.matches %}
                                <div class="small text-muted mt-1">
                                    Wanted:
                                    {% for m in ex.matches %}
                                        #{{ m.id }} {{ m.title }}{% if m.year %} ({{ m.year }}){% endif %}{% if m.media_type %} - {{ m.media_type }}{% endif %}{% if m.category %} - {{ m.category }}{% endif %}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="row g-2 mb-4">
        <div class="col-12 col-md-6">
            <input type="text" class="form-control" id="plex-search" placeholder="Filtra per titolo...">
        </div>
        <div class="col-12 col-md-6 d-flex align-items-center gap-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="plex-only-selected">
                <label class="form-check-label" for="plex-only-selected">Mostra solo selezionati</label>
            </div>
            <div class="btn-group" role="group" aria-label="Selezione tipo">
                <button type="button" class="btn btn-sm btn-primary type-toggle" data-type="movie">Film</button>
                <button type="button" class="btn btn-sm btn-secondary type-toggle" data-type="series">Serie</button>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-4">
        <div class="col-12 col-md-8">
            <input type="text" class="form-control" id="plex-basepath" placeholder="Seleziona per cartella base (es. N:\\Media\\Cortometraggi)">
        </div>
        <div class="col-12 col-md-4 d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="select-base-btn">Seleziona base</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-base-btn">Deseleziona base</button>
        </div>
    </div>

    {% if preview.options.import_movies %}
    <div class="mb-4">
        <h5>Film <small class="text-muted">(<span id="selected-movies">0</span> selezionati)</small></h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle plex-table">
                <thead>
                    <tr>
                        <th style="width: 36px;"></th>
                        <th class="sortable" data-sort-key="title">Titolo</th>
                        <th class="sortable" data-sort-key="year">Anno</th>
                        <th class="sortable" data-sort-key="tmdb">TMDB</th>
                        <th>Usa match</th>
                        <th class="sortable" data-sort-key="type">Tipo</th>
                        <th class="sortable" data-sort-key="path">Percorso</th>
                    </tr>
                </thead>
                <tbody>
                {% for pm in preview.movies|sort(attribute='title') %}
                    <tr class="plex-row" data-title="{{ pm.title|lower }}" data-type="movie" data-year="{{ pm.year or 0 }}" data-path="{{ pm.file_path|lower }}" data-tmdb="{{ pm.tmdb_title|lower if pm.tmdb_title else '' }}">
                        <td>
                            <input class="form-check-input plex-select plex-movie" type="checkbox" name="plex_guid" value="{{ pm.guid }}" checked>
                        </td>
                        <td>{{ pm.title }}</td>
                        <td>{{ pm.year }}</td>
                        <td>
                            {% if pm.tmdb_id %}
                                <a class="badge {{ 'bg-success' if pm.tmdb_confident else 'bg-warning text-dark' }} text-decoration-none"
                                   href="https://www.themoviedb.org/movie/{{ pm.tmdb_id }}"
                                   target="_blank"
                                   rel="noopener">
                                    {{ pm.tmdb_title }}{% if pm.tmdb_year %} ({{ pm.tmdb_year }}){% endif %}
                                </a>
                                {% if pm.tmdb_score %}
                                    <div class="text-muted small">Score {{ pm.tmdb_score }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Nessun match</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pm.tmdb_id %}
                                <input class="form-check-input" type="checkbox" name="tmdb_confirm" value="{{ pm.guid }}|{{ pm.tmdb_id }}" {% if pm.tmdb_confident %}checked{% endif %}>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>Film</td>
                        <td class="text-muted small">{{ pm.file_path }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    {% if preview.options.import_series %}
    <div class="mb-4">
        <h5>Serie <small class="text-muted">(<span id="selected-series">0</span> selezionate)</small></h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle plex-table">
                <thead>
                    <tr>
                        <th style="width: 36px;"></th>
                        <th class="sortable" data-sort-key="title">Titolo</th>
                        <th class="sortable" data-sort-key="year">Anno</th>
                        <th class="sortable" data-sort-key="tvdb">TVDB</th>
                        <th>Usa match</th>
                        <th class="sortable" data-sort-key="type">Tipo</th>
                        <th class="sortable" data-sort-key="path">Percorso</th>
                    </tr>
                </thead>
                <tbody>
                {% for pm in preview.series|sort(attribute='title') %}
                    <tr class="plex-row" data-title="{{ pm.title|lower }}" data-type="series" data-year="{{ pm.year or 0 }}" data-path="{{ pm.file_path|lower }}" data-tvdb="{{ pm.tvdb_title|lower if pm.tvdb_title else '' }}">
                        <td>
                            <input class="form-check-input plex-select plex-series" type="checkbox" name="plex_guid" value="{{ pm.guid }}" checked>
                        </td>
                        <td>{{ pm.title }}</td>
                        <td>{{ pm.year }}</td>
                        <td>
                            {% if pm.tvdb_id %}
                                <a class="badge {{ 'bg-success' if pm.tvdb_confident else 'bg-warning text-dark' }} text-decoration-none"
                                   href="https://thetvdb.com/?tab=series&id={{ pm.tvdb_id }}"
                                   target="_blank"
                                   rel="noopener">
                                    {{ pm.tvdb_title }}{% if pm.tvdb_year %} ({{ pm.tvdb_year }}){% endif %}
                                </a>
                                {% if pm.tvdb_score %}
                                    <div class="text-muted small">Score {{ pm.tvdb_score }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Nessun match</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pm.tvdb_id %}
                                <input class="form-check-input" type="checkbox" name="tvdb_confirm" value="{{ pm.guid }}|{{ pm.tvdb_id }}" {% if pm.tvdb_confident %}checked{% endif %}>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>Serie</td>
                        <td class="text-muted small">{{ pm.file_path }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</form>

{% endif %}

<div id="plex-loading" class="plex-loading d-none">
    <div class="plex-loading__backdrop"></div>
    <div class="plex-loading__card">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2" id="plex-loading-stage">Elaborazione DB Plex in corso…</div>
        <div class="text-muted small" id="plex-loading-detail">Operazione in background, attendi qualche istante.</div>
        <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar" role="progressbar" id="plex-loading-bar" style="width: 0%;"></div>
        </div>
    </div>
</div>

{% if report %}
    <hr>
    <h4>Report Import</h4>
    <p><strong>Media importati:</strong> {{ report.imported|length }}</p>
    <ul>
        {% for pm in report.imported %}
            <li>{{ pm.title }}</li>
        {% endfor %}
    </ul>

    <p><strong>Media saltati (già presenti):</strong> {{ report.skipped|length }}</p>
    <ul>
        {% for pm in report.skipped %}
            {% if pm is string %}
                <li>{{ pm }}</li>
            {% else %}
                <li>{{ pm.title }}</li>
            {% endif %}
        {% endfor %}
    </ul>

    {% if report.errors %}
        <p><strong>Errori:</strong></p>
        <ul class="text-danger">
            {% for err in report.errors %}
                <li>{{ err }}</li>
            {% endfor %}
        </ul>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='scripts/import_plex.js') }}"></script>
{% endblock %}
