{% extends "layout.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/import_plex.css') }}">
{% endblock %}

{% block content %}
<h2><i class="bi bi-database me-2"></i>Plex Import</h2>

{% if not preview %}
<form method="post" enctype="multipart/form-data" class="mb-4" id="plex-preview-form">
    <input type="hidden" name="action" value="preview">
    <input type="file" name="file" accept=".db" required>
    <button type="submit" class="btn btn-primary">Analizza DB</button>
</form>
{% endif %}

{% if preview %}
<form method="post">
    <input type="hidden" name="action" value="import">
    <input type="hidden" name="filepath" value="{{ preview.filepath }}">

    <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <span class="badge bg-primary">Film: {{ preview.movies|length }}</span>
        <span class="badge bg-secondary">Serie: {{ preview.series|length }}</span>
        {% if preview.excluded %}
            <span class="badge bg-warning text-dark">Esclusi: {{ preview.excluded|length }}</span>
        {% endif %}
        <span class="badge bg-info text-dark">Selezionati: <span id="selected-total">0</span></span>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="select-all-btn">Seleziona tutti</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-all-btn">Deseleziona</button>
        <button type="submit" class="btn btn-success" id="import-btn">Importa selezionati</button>
    </div>
    {% if preview.excluded %}
    <div class="mb-3">
        <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" data-bs-target="#plex-excluded" aria-expanded="false" aria-controls="plex-excluded">
            Esclusi ({{ preview.excluded|length }})
        </button>
    </div>
    <div class="collapse mb-4" id="plex-excluded">
        <div class="alert alert-warning py-2 small">
            Esclusi perche gia presenti nei wanted (match esatto titolo/anno).
        </div>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle">
                <thead>
                    <tr>
                        <th>Titolo</th>
                        <th>Anno</th>
                        <th>Tipo</th>
                        <th>Motivo</th>
                    </tr>
                </thead>
                <tbody>
                {% for ex in preview.excluded %}
                    <tr>
                        <td>{{ ex.title }}</td>
                        <td>{{ ex.year }}</td>
                        <td>{{ ex.media_type }}</td>
                        <td class="text-muted">{{ ex.reason }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <div class="row g-2 mb-4">
        <div class="col-12 col-md-6">
            <input type="text" class="form-control" id="plex-search" placeholder="Filtra per titolo...">
        </div>
        <div class="col-12 col-md-6 d-flex align-items-center gap-3">
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="plex-only-selected">
                <label class="form-check-label" for="plex-only-selected">Mostra solo selezionati</label>
            </div>
            <div class="btn-group" role="group" aria-label="Selezione tipo">
                <button type="button" class="btn btn-sm btn-primary type-toggle" data-type="movie">Film</button>
                <button type="button" class="btn btn-sm btn-secondary type-toggle" data-type="series">Serie</button>
            </div>
        </div>
    </div>

    <div class="row g-2 mb-4">
        <div class="col-12 col-md-8">
            <input type="text" class="form-control" id="plex-basepath" placeholder="Seleziona per cartella base (es. N:\\Media\\Cortometraggi)">
        </div>
        <div class="col-12 col-md-4 d-flex align-items-center gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" id="select-base-btn">Seleziona base</button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-base-btn">Deseleziona base</button>
        </div>
    </div>

    <div class="mb-4">
        <h5>Film <small class="text-muted">(<span id="selected-movies">0</span> selezionati)</small></h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle plex-table">
                <thead>
                    <tr>
                        <th style="width: 36px;"></th>
                        <th class="sortable" data-sort-key="title">Titolo</th>
                        <th class="sortable" data-sort-key="year">Anno</th>
                        <th class="sortable" data-sort-key="tmdb">TMDB</th>
                        <th class="sortable" data-sort-key="type">Tipo</th>
                        <th class="sortable" data-sort-key="path">Percorso</th>
                    </tr>
                </thead>
                <tbody>
                {% for pm in preview.movies %}
                    <tr class="plex-row" data-title="{{ pm.title|lower }}" data-type="movie" data-year="{{ pm.year or 0 }}" data-path="{{ pm.file_path|lower }}" data-tmdb="{{ pm.tmdb_title|lower if pm.tmdb_title else '' }}">
                        <td>
                            <input class="form-check-input plex-select plex-movie" type="checkbox" name="plex_guid" value="{{ pm.guid }}" checked>
                            <input type="hidden" name="tmdb_match" value="{{ pm.guid }}|{{ pm.tmdb_id or '' }}|{{ '1' if pm.tmdb_confident else '0' }}">
                        </td>
                        <td>{{ pm.title }}</td>
                        <td>{{ pm.year }}</td>
                        <td>
                            {% if pm.tmdb_id %}
                                <span class="badge {{ 'bg-success' if pm.tmdb_confident else 'bg-warning text-dark' }}">
                                    {{ pm.tmdb_title }}{% if pm.tmdb_year %} ({{ pm.tmdb_year }}){% endif %}
                                </span>
                                {% if pm.tmdb_score %}
                                    <div class="text-muted small">Score {{ pm.tmdb_score }}</div>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Nessun match</span>
                            {% endif %}
                        </td>
                        <td>Film</td>
                        <td class="text-muted small">{{ pm.file_path }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="mb-4">
        <h5>Serie <small class="text-muted">(<span id="selected-series">0</span> selezionate)</small></h5>
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle plex-table">
                <thead>
                    <tr>
                        <th style="width: 36px;"></th>
                        <th class="sortable" data-sort-key="title">Titolo</th>
                        <th class="sortable" data-sort-key="year">Anno</th>
                        <th class="sortable" data-sort-key="type">Tipo</th>
                        <th class="sortable" data-sort-key="path">Percorso</th>
                    </tr>
                </thead>
                <tbody>
                {% for pm in preview.series %}
                    <tr class="plex-row" data-title="{{ pm.title|lower }}" data-type="series" data-year="{{ pm.year or 0 }}" data-path="{{ pm.file_path|lower }}">
                        <td>
                            <input class="form-check-input plex-select plex-series" type="checkbox" name="plex_guid" value="{{ pm.guid }}" checked>
                        </td>
                        <td>{{ pm.title }}</td>
                        <td>{{ pm.year }}</td>
                        <td>Serie</td>
                        <td class="text-muted small">{{ pm.file_path }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</form>

{% endif %}

<div id="plex-loading" class="plex-loading d-none">
    <div class="plex-loading__backdrop"></div>
    <div class="plex-loading__card">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-2" id="plex-loading-stage">Elaborazione DB Plex in corso…</div>
        <div class="text-muted small" id="plex-loading-detail">Operazione in background, attendi qualche istante.</div>
        <div class="progress mt-2" style="height: 6px;">
            <div class="progress-bar" role="progressbar" id="plex-loading-bar" style="width: 0%;"></div>
        </div>
    </div>
</div>

{% if report %}
    <hr>
    <h4>Report Import</h4>
    <p><strong>Media importati:</strong> {{ report.imported|length }}</p>
    <ul>
        {% for pm in report.imported %}
            <li>{{ pm.title }}</li>
        {% endfor %}
    </ul>

    <p><strong>Media saltati (già presenti):</strong> {{ report.skipped|length }}</p>
    <ul>
        {% for pm in report.skipped %}
            {% if pm is string %}
                <li>{{ pm }}</li>
            {% else %}
                <li>{{ pm.title }}</li>
            {% endif %}
        {% endfor %}
    </ul>

    {% if report.errors %}
        <p><strong>Errori:</strong></p>
        <ul class="text-danger">
            {% for err in report.errors %}
                <li>{{ err }}</li>
            {% endfor %}
        </ul>
    {% endif %}
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='scripts/import_plex.js') }}"></script>
{% endblock %}
