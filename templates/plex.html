{% extends "layout.html" %}

{% block content %}
<style>
    #plex_table {
        table-layout: fixed;
        width: 100%;
    }
    #plex_table th,
    #plex_table td {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    #plex_table th:nth-child(1),
    #plex_table td:nth-child(1) { width: 40%; }
    #plex_table th:nth-child(2),
    #plex_table td:nth-child(2) { width: 8%; }
    #plex_table th:nth-child(3),
    #plex_table td:nth-child(3) { width: 10%; }
    #plex_table th:nth-child(4),
    #plex_table td:nth-child(4) { width: 18%; }
    #plex_table th:nth-child(5),
    #plex_table td:nth-child(5) { width: 6%; text-align: center; }
    #plex_table th:nth-child(6),
    #plex_table td:nth-child(6) { width: 6%; text-align: center; }
    #plex_table th:nth-child(7),
    #plex_table td:nth-child(7) { width: 6%; text-align: center; }
    #plex_table th:nth-child(8),
    #plex_table td:nth-child(8) { width: 6%; text-align: center; }
    .plex-skeleton {
        display: grid;
        gap: 10px;
        margin-bottom: 16px;
    }
    .plex-skeleton__row {
        height: 46px;
        border-radius: 8px;
        background: linear-gradient(90deg, #eceff3 25%, #f6f7f9 37%, #eceff3 63%);
        background-size: 400% 100%;
        animation: plex-shimmer 1.2s ease-in-out infinite;
    }
    @keyframes plex-shimmer {
        0% { background-position: 100% 0; }
        100% { background-position: 0 0; }
    }
    #plexDetailModal .modal-content {
        position: relative;
        overflow: hidden;
    }
    #plexDetailModal .plex-detail-backdrop-bg {
        position: absolute;
        inset: 0;
        background-size: cover;
        background-position: center;
        opacity: 0.12;
        pointer-events: none;
    }
    #plexDetailModal .modal-header,
    #plexDetailModal .modal-body,
    #plexDetailModal .modal-footer {
        position: relative;
        z-index: 1;
    }
</style>
<h2><i class="bi bi-collection-play me-2"></i>Plex Library</h2>
<p>
    Totali: <span id="plex-count-total">0</span> |
    Film: <span id="plex-count-movies">0</span> |
    Serie: <span id="plex-count-series">0</span>
</p>

<div class="row g-2 mb-3">
    <div class="col-12 col-md-6">
        <input type="text" class="form-control" id="plex-title-search" placeholder="Cerca per titolo...">
    </div>
    <div class="col-6 col-md-3">
        <select class="form-select" id="plex-type-filter">
            <option value="">Tutti i tipi</option>
        </select>
    </div>
    <div class="col-6 col-md-3">
        <select class="form-select" id="plex-library-filter">
            <option value="">Tutte le librerie</option>
        </select>
    </div>
</div>

<div id="plex-skeleton" class="plex-skeleton">
    <div class="plex-skeleton__row"></div>
    <div class="plex-skeleton__row"></div>
    <div class="plex-skeleton__row"></div>
    <div class="plex-skeleton__row"></div>
    <div class="plex-skeleton__row"></div>
</div>

<table id="plex_table" class="table table-striped table-bordered d-none">
    <thead>
        <tr>
            <th>Title</th>
            <th>Year</th>
            <th>Type</th>
            <th>Library</th>
            <th class="text-center">Radarr</th>
            <th class="text-center">Sonarr</th>
            <th class="text-center">Wanted</th>
            <th class="text-center">Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div class="modal fade" id="plexDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="plex-detail-backdrop-bg d-none" id="plex-detail-backdrop-bg"></div>
            <div class="modal-header">
                <h5 class="modal-title" id="plex-detail-title">Dettagli Plex</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info d-none" id="plex-detail-loading">Carico dettagli...</div>
                <div class="alert alert-danger d-none" id="plex-detail-error">Errore nel caricamento.</div>
                <div id="plex-detail-body" class="d-none">
                    <div class="d-flex gap-3 mb-3 align-items-start">
                        <img id="plex-detail-poster" class="rounded shadow-sm d-none" alt="Plex Poster" style="width: 180px; height: auto;">
                        <div class="flex-grow-1">
                            <div class="fw-semibold mb-1">Trama:</div>
                            <p class="plex-detail-summary mb-0" id="plex-detail-summary"></p>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-12 col-md-6"><strong>Anno:</strong> <span id="plex-detail-year"></span></div>
                        <div class="col-12 col-md-6"><strong>Tipo:</strong> <span id="plex-detail-type"></span></div>
                        <div class="col-12 col-md-6"><strong>Studio:</strong> <span id="plex-detail-studio"></span></div>
                        <div class="col-12 col-md-6"><strong>Rating:</strong> <span id="plex-detail-rating"></span></div>
                        <div class="col-12 col-md-6"><strong>Audience:</strong> <span id="plex-detail-audience"></span></div>
                        <div class="col-12 col-md-6"><strong>Content Rating:</strong> <span id="plex-detail-content-rating"></span></div>
                        <div class="col-12 col-md-6"><strong>Durata:</strong> <span id="plex-detail-duration"></span></div>
                        <div class="col-12 col-md-6"><strong>Visti:</strong> <span id="plex-detail-view-count"></span></div>
                        <div class="col-12 col-md-6"><strong>Ultima visione:</strong> <span id="plex-detail-last-viewed"></span></div>
                        <div class="col-12 col-md-6"><strong>Original Title:</strong> <span id="plex-detail-original-title"></span></div>
                        <div class="col-12"><strong>Generi:</strong> <span id="plex-detail-genres"></span></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    var plexTable = $('#plex_table').DataTable({
        paging: true,
        ordering: true,
        order: [[1, "desc"]],
        pageLength: 25,
        autoWidth: false,
        deferRender: true,
        ajax: {
            url: '/api/plex/media',
            dataSrc: function(json) {
                if (json && json.counts) {
                    $('#plex-count-total').text(json.counts.total || 0);
                    $('#plex-count-movies').text(json.counts.movies || 0);
                    $('#plex-count-series').text(json.counts.series || 0);
                }
                return json.items || [];
            }
        },
        columns: [
            { data: 'title' },
            { data: 'year' },
            { data: 'media_type' },
            { data: 'library' },
            {
                data: 'in_radarr',
                orderable: true,
                render: function(data, type) {
                    if (type === 'sort' || type === 'type') {
                        return data ? 1 : 0;
                    }
                    return data
                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                        : '<i class="bi bi-dash-circle text-muted"></i>';
                }
            },
            {
                data: 'in_sonarr',
                orderable: true,
                render: function(data, type) {
                    if (type === 'sort' || type === 'type') {
                        return data ? 1 : 0;
                    }
                    return data
                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                        : '<i class="bi bi-dash-circle text-muted"></i>';
                }
            },
            {
                data: 'in_wanted',
                orderable: true,
                render: function(data, type) {
                    if (type === 'sort' || type === 'type') {
                        return data ? 1 : 0;
                    }
                    return data
                        ? '<i class="bi bi-check-circle-fill text-success"></i>'
                        : '<i class="bi bi-dash-circle text-muted"></i>';
                }
            },
            {
                data: 'rating_key',
                orderable: false,
                render: function(data) {
                    return '<button class="btn btn-sm btn-outline-primary plex-detail-btn" type="button" data-rating-key="' + data + '">Dettagli</button>';
                }
            }
        ],
        initComplete: function() {}
    });

    plexTable.on('xhr', function() {
        var skeleton = document.getElementById('plex-skeleton');
        if (skeleton) {
            skeleton.style.display = 'none';
        }
        document.getElementById('plex_table').classList.remove('d-none');
    });

    function populateSelect($select, values) {
        var options = values.map(function(value) {
            return '<option value="' + value + '">' + value + '</option>';
        }).join('');
        $select.append(options);
    }

    function getUniqueValuesFromItems(items, key) {
        var map = {};
        (items || []).forEach(function(item) {
            var cleaned = String(item[key] || '').trim();
            if (!cleaned) {
                return;
            }
            map[cleaned] = true;
        });
        return Object.keys(map).sort();
    }

    plexTable.on('xhr', function(event, settings, json) {
        var items = (json && json.items) ? json.items : [];
        $('#plex-type-filter').find('option:not(:first)').remove();
        $('#plex-library-filter').find('option:not(:first)').remove();
        populateSelect($('#plex-type-filter'), getUniqueValuesFromItems(items, 'media_type'));
        populateSelect($('#plex-library-filter'), getUniqueValuesFromItems(items, 'library'));
    });

    $('#plex-title-search').on('input', function() {
        plexTable.column(0).search(this.value || '').draw();
    });
    $('#plex-type-filter').on('change', function() {
        plexTable.column(2).search(this.value || '', true, false).draw();
    });
    $('#plex-library-filter').on('change', function() {
        plexTable.column(3).search(this.value || '', true, false).draw();
    });

    function fmtDuration(ms) {
        if (!ms) {
            return '';
        }
        var minutes = Math.round(ms / 60000);
        return minutes + ' min';
    }

    function fmtDate(ts) {
        if (!ts) {
            return '';
        }
        var d = new Date(ts * 1000);
        return d.toLocaleString();
    }

    function fillDetails(details) {
        $('#plex-detail-title').text(details.title || 'Dettagli Plex');
        $('#plex-detail-summary').text(details.summary || '');
        if (details.poster_url) {
            $('#plex-detail-poster').attr('src', details.poster_url).removeClass('d-none');
        } else {
            $('#plex-detail-poster').addClass('d-none').attr('src', '');
        }
        if (details.backdrop_url) {
            $('#plex-detail-backdrop-bg').css('background-image', 'url(' + details.backdrop_url + ')').removeClass('d-none');
        } else {
            $('#plex-detail-backdrop-bg').addClass('d-none').css('background-image', '');
        }
        $('#plex-detail-year').text(details.year || '');
        $('#plex-detail-type').text(details.type || '');
        $('#plex-detail-studio').text(details.studio || '');
        $('#plex-detail-rating').text(details.rating || '');
        $('#plex-detail-audience').text(details.audience_rating || '');
        $('#plex-detail-content-rating').text(details.content_rating || '');
        $('#plex-detail-duration').text(fmtDuration(details.duration));
        $('#plex-detail-view-count').text(details.view_count || '');
        $('#plex-detail-last-viewed').text(fmtDate(details.last_viewed_at));
        $('#plex-detail-original-title').text(details.original_title || '');
        $('#plex-detail-genres').text((details.genres || []).join(', '));
    }

    $(document).on('click', '.plex-detail-btn', function() {
        var ratingKey = $(this).data('rating-key');
        if (!ratingKey) {
            return;
        }
        $('#plex-detail-body').addClass('d-none');
        $('#plex-detail-error').addClass('d-none');
        $('#plex-detail-loading').removeClass('d-none');
        var modalEl = document.getElementById('plexDetailModal');
        var modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
        fetch('/api/plex/media/' + ratingKey)
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                $('#plex-detail-loading').addClass('d-none');
                if (!data || !data.ok) {
                    throw new Error('not found');
                }
                fillDetails(data.details || {});
                $('#plex-detail-body').removeClass('d-none');
            })
            .catch(function() {
                $('#plex-detail-loading').addClass('d-none');
                $('#plex-detail-error').removeClass('d-none');
            });
    });
});
</script>
{% endblock %}
