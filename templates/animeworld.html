{% extends "layout.html" %}
{% block content %}

<h2 class="mb-4">AnimeWorld</h2>

<!-- SEARCH FORM -->
<form method="POST" class="mb-4">
    <div class="input-group input-group-lg">
        <input type="text"
               name="search_query"
               class="form-control"
               placeholder="Cerca un anime su AnimeWorld..."
               value="{{ query or '' }}"
               required>
        <button class="btn btn-primary">Cerca</button>
    </div>
</form>

{% if results %}
<hr>

<div class="row">
    {% for anime in results %}
    <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm position-relative">

            <!-- STATUS BADGE -->
            {% if anime.status %}
            <span class="badge position-absolute top-0 end-0 m-2 
                {% if anime.status == 'new' %}bg-success
                {% elif anime.status == 'wanted' %}bg-warning
                {% elif anime.status == 'downloading' %}bg-primary
                {% elif anime.status == 'completed' %}bg-secondary
                {% elif anime.status == 'failed' %}bg-danger
                {% else %}bg-light text-dark{% endif %}">
                {{ anime.status|capitalize }}
            </span>
            {% endif %}

            <!-- COVER -->
            <img src="{{ anime.cover }}"
                 class="card-img-top"
                 style="object-fit: cover; max-height: 380px;"
                 alt="{{ anime.title }}">

            <div class="card-body d-flex flex-column">

                <!-- TITLE -->
                <h5 class="card-title mb-1">{{ anime.title }}</h5>

                {% if anime.original_title %}
                <small class="text-muted">{{ anime.original_title }}</small>
                {% endif %}

                <!-- META -->
                <p class="mt-2 mb-1">
                    <strong>{{ anime.year }}</strong> · {{ anime.episodes }} episodi
                </p>

                <p class="small text-muted mb-2">
                    Studio: {{ anime.studio }}<br>
                    Season: {{ anime.season }}<br>
                    Lingua: {{ anime.language }}
                </p>

                <!-- ACTIONS -->
                <div class="mt-auto d-flex gap-2">
                    <button class="btn btn-outline-primary btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#animeModal{{ anime.source_id }}">
                        Dettagli
                    </button>

                    <form method="POST"
                          action="{{ url_for('add_wanted_anime_route') }}">
                        <input type="hidden" name="anime_id" value="{{ anime.source_id }}">
                        <input type="hidden" name="anime_link" value="{{ anime.link }}">
                        <input type="hidden" name="title" value="{{ anime.title }}">
                        <input type="hidden" name="year" value="{{ anime.year }}">
                        <input type="hidden" name="episodes" value="{{ anime.episodes }}">
                        <input type="hidden" name="search_query" value="{{ query or '' }}">
                        <input type="hidden" name="anilist_id" value="{{ anime.anilist_id or '' }}">
                        <input type="hidden" name="original_title" value="{{ anime.original_title or '' }}">
                        <input type="hidden" name="language" value="{{ anime.language or '' }}">
                        <button class="btn btn-success btn-sm">
                            Aggiungi ai Wanted
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL -->
    <div class="modal fade"
         id="animeModal{{ anime.source_id }}"
         tabindex="-1"
         aria-hidden="true">

        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">{{ anime.title }}</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-4">
                            <img src="{{ anime.cover }}"
                                 class="img-fluid rounded mb-3"
                                 alt="{{ anime.title }}">
                        </div>

                        <div class="col-md-8">
                            <p><strong>Titolo originale:</strong> {{ anime.original_title }}</p>
                            <p><strong>Episodi:</strong> {{ anime.episodes }}</p>
                            <p><strong>Durata ep:</strong> {{ anime.duration }} min</p>
                            <p><strong>Studio:</strong> {{ anime.studio }}</p>
                            <p><strong>Lingua:</strong> {{ anime.language }}</p>
                            <p><strong>Doppiato:</strong>
                                {{ "Sì" if anime.dub else "No" }}
                            </p>
                            <p><strong>MAL:</strong> ⭐ {{ anime.mal_vote }}</p>
                        </div>
                    </div>

                    <hr>

                    <p>{{ anime.description }}</p>
                </div>

                <div class="modal-footer">
                    <a href="{{ anime.link }}"
                       target="_blank"
                       class="btn btn-outline-secondary">
                        Apri su AnimeWorld
                    </a>
                    <button class="btn btn-secondary"
                            data-bs-dismiss="modal">
                        Chiudi
                    </button>
                </div>

            </div>
        </div>
    </div>

    {% endfor %}
</div>

{% elif query %}
<div class="alert alert-warning">
    Nessun risultato trovato.
</div>
{% endif %}

{% endblock %}